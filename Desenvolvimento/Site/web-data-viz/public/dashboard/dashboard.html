<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solomon’s - Dashboard</title>

    <link rel="icon" href="../assets/Logo.png">
    <link rel="stylesheet" href="../css/dashboards.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair:ital,opsz,wght@0,5..1200,300..900;1,5..1200,300..900&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Playfair:ital,opsz,wght@0,5..1200,300..900;1,5..1200,300..900&family=Saira:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Playfair:ital,opsz,wght@0,5..1200,300..900;1,5..1200,300..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Saira:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <header id="header">
        <nav id="logo">
            <div>
                <img src="../assets/Logo.png">
            </div>
            <div id="nome_site">
                <h3>Solomon’s</h3>
            </div>
        </nav>
        <nav id="links">
            <div id="usuario">
                <div>
                    <img id="icon_user" src="../assets/dashboard/imagem-do-usuario-com-fundo-preto.png">
                </div>
                <span id="b_usuario">Vinicius Gonçalves</span>
                
                <div class="menu_toggle" id="menu_toggle">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>

                <div class="side_menu" id="side_menu">
                    <div class="conteudo_menu">
                        <div class="titulo_menu" id="titulo_menu">
                            <p>Opções</p>
                        </div>
                        <div id="opcoes_menu">
                            <div>
                                <img src="../assets/dashboard/configuracoes.png" alt="">
                                <p>Configurações</p>
                            </div>
                            <div>
                                <img src="../assets/dashboard/sair.png" alt="">
                                <p>Sair</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div id="menu_estudos" class="hidden">
            <div id="conteudo_estudos">
                <div id="titulo_menu">
                    <p>Aulas</p>
                    <span id="toggle_icon">▶</span>
                </div>
                <div id="materias">
                    <div id="titulo_materia">
                        <p>Teologia</p>
                    </div>
                    <ul id="submenu">
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=2'>Aula 1 - A IMPORTÂNCIA DA DOUTRINA BÍBLICA</a> 
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=5'>Aula 2 - INTERPRETAÇÃO BÍBLICA</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=6'>Aula 3 - A EXISTÊNCIA DE DEUS</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=ekf46Kpnvlc&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=7'>Aula 4 - O MISTÉRIO DA TRINDADE</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=11'>Aula 5 - A CRIAÇÃO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=16'>Aula 6 - A VOLTA DE JESUS</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=20'>Aula 7 - O BATISMO EM ÁGUA</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=27'>Aula 8 - CRIAÇÃO E QUEDA DO HOMEM</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=29'>Aula 9 - O NOVO NASCIMENTO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=38'>Aula 10 - A JUSTIFICAÇÃO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=36'>Aula 11 - A SANTIFICAÇÃO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=40'>Aula 12 - A GLORIFICAÇÃO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=53'>Aula 13 - OS DONS DO ESPÍRITO</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=67'>Aula 14 - A LEITURA BÍBLICA</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=66'>Aula 15 - POR QUE ORAR?</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=Y2enuVGKyCQ&list=PL7BFepC9j7U1egnY7Wk9ej-8T4aj2DStb&index=68'>Aula 16 - O JEJUM</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=KmpucxGB1jA&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf'>Aula 17 - A História do Cristianismo | Episódio 01</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=xyE4U2oFbGU&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=2'>Aula 18 - A História do Cristianismo | Episódio 2</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=mjgNsyPDA4k&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=3'>Aula 19 - A História do Cristianismo | Episódio 3</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=mjgNsyPDA4k&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=4'>Aula 20 - A História do Cristianismo | Episódio 4</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=mjgNsyPDA4k&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=5'>Aula 21 - A História do Cristianismo | Episódio 5</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=mjgNsyPDA4k&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=6'>Aula 22 - A História do Cristianismo | Episódio 6</a>
                        </li>
                        <div id="separador"></div>
                        <li><a href = 'https://www.youtube.com/watch?v=mjgNsyPDA4k&list=PLZ4pKq9EIdzxzr5269KlYThKXeEVL6BVf&index=7'>Aula 23 - A História do Cristianismo | Episódio Extra</a>
                        </li>
                        <div id="separador"></div>
                    </ul>
                </div>
            </div>
        </div>

        <div id="visao_estudos">
            <div id="selecoes">
                <img src="../assets/dashboard/laptop (1).png">
                <p>Dashboard</p>
                <select name="" id="materia">
                    <option value="teologia">Teologia</option>
                    <option value="financas">Finanças</option>
                    <option value="politica">Politica</option>
                    <option value="desenvolvimento">Desenvolvimento Pessoal</option>
                    <option value="programacao">Programação</option>
                </select>
            </div>

            <div id="selecoes">
                <p>Aulas assistidas:</p>
                <input id="input_aulas_assistidas">
                <button onclick="registrarProdutividade()">Salvar</button>
            </div>

        </div>

        <div id="dash">
            <div id="visaoProdutividadeGeral">
                <div id="titulo">
                    <p  class="kpi_titulo">Visão de produtividade</p>
                </div>
                <div id="grafico">
                    <canvas id="myChart"></canvas>
                </div>
            </div>

            <div id="visaoSecundaria">
                <div id="kpis">
                    <div class="kpi_informacao" id="consistencia">
                        <div id="titulo">
                            <p class="kpi_titulo">Consistência</p>
                        </div>
                        <div class="kpi_conteudo" id="conteudo_consistencia">
                            <img src="../assets/dashboard/raio (1).png">
                            <span id="dias_consistencia" class="kpi_dado">0 Dias</span>
                        </div>
                    </div>
    
                    <div class="kpi_informacao" id="progressao">
                        <div id="titulo">
                            <p  class="kpi_titulo">Progressão</p>
                        </div>
                        <div class="kpi_conteudo" id="conteudo_progressao">
                            <img src="../assets/dashboard/progressao-grafica.png">
                            <p class="kpi_dado">50/10</p>
                        </div>
                    </div>
                </div>

                <div id="div_visaoMaterias">
                    <div id="titulo">
                        <p  class="kpi_titulo">Aulas realizadas</p>
                    </div>
                    <div id="materiasRealizadas">
                        <canvas id="chartMetas"></canvas>
                    </div>
                </div>

            </div>
        </div>

    </main>

</body>
</html>

<script src="../js/dashboard.js"></script>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

let proximaAtualizacao;

var idUsuario = sessionStorage.ID_USUARIO;
console.log(idUsuario);  // Vai imprimir o ID armazenado

/*window.onload = exibirAquariosDoUsuario();

function exibirAquariosDoUsuario() {
    var aquarios = JSON.parse(sessionStorage.AQUARIOS);
    aquarios.forEach(item => {
        document.getElementById("btnAquario").innerHTML += `
        <button class="btn-chart" onclick="exibirAquario(${item.id})" id="btnAquario${item.id}">${item.descricao}</button>
        `

        document.getElementById("graficos").innerHTML += `
            <div id="grafico${item.id}" class="display-none">
                <h3 class="tituloGraficos">
                    <span id="tituloAquario${item.id}">${item.descricao}</span>
                </h3>
                <div class="graph">
                    <canvas id="myChartCanvas${item.id}"></canvas>
                </div>
                <div class="label-captura">
                    <p id="avisoCaptura${item.id}" style="color: white"></p>
                </div>
            </div>
        `

        obterDadosGrafico(item.id)
    });

    if (aquarios.length > 0) {
        exibirAquario(aquarios[0].id)
    }
}

function alterarTitulo(idAquario) {
    var tituloAquario = document.getElementById(`tituloAquario${idAquario}`)
    var descricao = JSON.parse(sessionStorage.AQUARIOS).find(item => item.id == idAquario).descricao;
    tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>" + descricao + "</span>"
}

function exibirAquario(idAquario) {
    let todosOsGraficos = JSON.parse(sessionStorage.AQUARIOS);

    for (i = 0; i < todosOsGraficos.length; i++) {
        // exibindo - ou não - o gráfico
        if (todosOsGraficos[i].id != idAquario) {
            let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].id}`)
            if (elementoAtual.classList.contains("display-block")) {
                elementoAtual.classList.remove("display-block")
            }
            elementoAtual.classList.add("display-none")

            // alterando estilo do botão
            let btnAtual = document.getElementById(`btnAquario${todosOsGraficos[i].id}`)
            if (btnAtual.classList.contains("btn-pink")) {
                btnAtual.classList.remove("btn-pink")
            }
            btnAtual.classList.add("btn-white")
        }
    }

    // exibindo - ou não - o gráfico
    let graficoExibir = document.getElementById(`grafico${idAquario}`)
    graficoExibir.classList.remove("display-none")
    graficoExibir.classList.add("display-block")

    // alterando estilo do botão
    let btnExibir = document.getElementById(`btnAquario${idAquario}`)
    btnExibir.classList.remove("btn-white")
    btnExibir.classList.add("btn-pink")
}*/

function registrarProdutividade() {
    var produtividadeVar = Number(input_aulas_assistidas.value);
    var idUsuario = sessionStorage.ID_USUARIO;

    if (idUsuario !== null) {
        console.log("ID do Usuário:", idUsuario); // Exibe o ID do usuário
    } else {
        console.log("ID do Usuário não encontrado.");
    }

    // Enviando o valor da nova input
    fetch("/medidas/registrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
  
        produtividadeServer: produtividadeVar,
        fkUsuarioServer: idUsuario,
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          cardErro.style.display = "block";

        } else {
          throw "Houve um erro ao tentar realizar o registro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    return false;
  }

// O gráfico é construído com três funções:
// 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
// 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
// 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

// Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
// para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
// A função *obterDadosGrafico* também invoca a função *plotarGrafico*

//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
//     Para ajustar o "select", ajuste o comando sql em src/models

function obterDadosGrafico() {
    var idUsuario = sessionStorage.ID_USUARIO

    fetch(`/medidas/ultimas`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                resposta.reverse();

                plotarGrafico(resposta);

            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
}

// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
// Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
// A função *plotarGrafico* também invoca a função *atualizarGrafico*
function plotarGrafico(resposta) {

    console.log('iniciando plotagem do gráfico...');


    // Criando estrutura para plotar gráfico - labels
    let labels = [1,2,3,4,5,6,7,8,9];
    let dadosProdutividade = [];

    resposta.forEach((registro) => {
        labels.push(`Registro ${registro.dado}`);
        dadosProdutividade.push(registro.produtividade);
    });

    // Criando estrutura para plotar gráfico - dados
    let data = {
        labels: labels,
        datasets: [{
            label: 'Meta Atingida',
            data: dadosProdutividade,
            fill: false,
            //backgroundColor: 'rgba(54, 162, 235, 0.2)',
            //borderColor: 'rgba(54, 162, 235, 1)',
            tension: 0.1
        },
        //{
        //    label: 'Meta Ideal',
        //    data: [5, 5, 5, 5, 5, 5, 5, 5, 5],
        //    borderColor: 'rgb(79, 122, 63)',
        //    borderWidth: 1,
        //    fill: false,
        //    pointBackgroundColor: 'rgb(79, 122, 63)',
        //},
        //{
        //    label: 'Meta Mínima',
        //    data: [1, 1, 1, 1, 1, 1, 1, 1, 1],
        //    borderColor: 'rgb(242, 172, 172)',
        //    borderWidth: 1,
        //    fill: false,
        //    pointBackgroundColor: 'rgb(242, 172, 172)',
        //}
        ]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];

        labels.push(registro.dado);
        
        dados.datasets[0].data.push(registro.produtividade);

    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    const config = {
    type: 'line',
    data: data,
    options: {
        plugins: {
            legend: {
                labels: {
                    color: 'black', // Cor do texto da legenda
                    generateLabels: function(chart) {
                        // Mantém as cores iguais às linhas do gráfico
                        return chart.data.datasets.map(function(dataset, i) {
                            return {
                                text: dataset.label,
                                fillStyle: dataset.borderColor, // Quadrado com a mesma cor da borda
                                strokeStyle: dataset.borderColor,
                                lineWidth: dataset.borderWidth,
                                datasetIndex: i
                            };
                        });
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    display: false // Remove as linhas de grade verticais
                }
            },
            y: {
                grid: {
                    display: false // Remove as linhas de grade horizontais
                    }
                }
            }
        }
    }

    // Adicionando gráfico criado em div na tela
    const myChart = new Chart(
    document.getElementById('myChart'),
    config
    )

    //setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
}


// Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
// buscando a última medida inserida em tabela contendo as capturas, 

//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
//     Para ajustar o "select", ajuste o comando sql em src/models
/*function atualizarGrafico(idAquario, dados, myChart) {



    fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {

                obterdados(idAquario);
                // alertar(novoRegistro, idAquario);
                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                console.log(`Dados atuais do gráfico:`);
                console.log(dados);

                let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
                avisoCaptura.innerHTML = ""


                if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                    console.log("---------------------------------------------------------------")
                    console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                    avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                    console.log("Horário do novo dado capturado:")
                    console.log(novoRegistro[0].momento_grafico)
                    console.log("Horário do último dado capturado:")
                    console.log(dados.labels[dados.labels.length - 1])
                    console.log("---------------------------------------------------------------")
                } else {
                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                    dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                    myChart.update();
                }

                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });

}*/

function sumirMensagem() {
    cardErro.style.display = "none";
  }
</script>